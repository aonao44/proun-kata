# 要件定義書（最新版・差分統合）

## 1. 目的
英会話教師が生徒の「実際の発音」を客観的に把握できるよう、補正なしでカタカナに起こすアプリを提供する。

## 2. 基本方針
- 発音の忠実な再現を最優先する。
- 音声認識結果に辞書・言語モデル・単語推定・正書法正規化などの補正を一切行わず、得られた音素列をルール変換でカタカナ化する。

## 3. 全体構成
```
[Client (Web/RN)録音] ── WAV ──▶ [Local PC FastAPI]
                                     ├─ 前処理(VAD任意)
                                     ├─ 音素認識(ASR, CTC greedy, LM=0)
                                     ├─ 音素正規化(strip stress, IPA→ARPAbet変換)
                                     ├─ ルールベース変換(phones→kana)
                                     └─ JSON応答
      ▲
      └─ Cloudflare Tunnel / ngrok 公開URL
```

## 4. 音素認識エンジン
- 選択肢1：Julius 英語音素AM、モジュールモード（10500ポート）、音素列ストリーミング出力可。
- 選択肢2：Wav2Vec2-phoneme (CTC)、Hugging Faceモデル（IPA/ARPAbet）。CTC greedy のみ。
- 非推奨：Vosk（音素未成熟）、Whisper（単語化・再学習必須）。
- 補足：将来のストリーミングIFとして `/ws/phoneme` を予約。MVPでは HTTP 一括POSTで十分。

## 5. 音素前処理
- ストレス番号を削除（例：IH1 → IH）。
- IPAモデル利用時は IPA→ARPAbet 変換層で統一。
- 無音/雑音（SIL/NSN/SP）は phones 配列に残し、カタカナ変換では空文字にする。

## 6. 音素→カタカナ変換ルール
- 子音+母音(CV)合成を基本とし、存在しない組み合わせは促音・母音挿入で埋める。
- 二重母音：EY→「ェイ/メィ」、AY→「ァイ」、OW→「オウ」、OY→「ォイ」、AW→「ァウ」。
- 語末処理：T→ッ/ッツ、K→ック、P→ップ、S→ス、N→ン、R/L→ル。
- 特殊処理：TH→ス/ズ（パラメータで切替）、flap(D)は D として扱う。
- 子音的R（ER）は「ァー＋ル」で表現。
- 連続促音「ッッ」は正規化して「ッ」1つに統合。

## 7. API仕様
- `POST /transcribe_phonetic`（multipart/form-data）。
- オプション：`style=rough|loan`、`final_c_t=xtsu|tsu`、`th=su|zu`。
- 応答例：
  ```json
  {
    "phones": [{"p": "M", "start": 0.12, "end": 0.18, "conf": 0.82}, ...],
    "kana": [{"k": "メ", "start": 0.12, "end": 0.18}, ...],
    "kana_text": "メィキッツ"
  }
  ```

## 8. クライアント表示
- 録音→API送信→カタカナ文字列表示。
- オプショントグル（`style`、`final_c_t`、`th`）。
- 簡易タイムライン（音素・カナのバー）は任意。

## 9. 非機能要件
- 同時ユーザ：2〜5人（開発PCを想定）。
- レイテンシ：短フレーズで 0.3〜0.8 秒。
- 可用性：PC稼働に依存し、Cloudflare/ngrok トンネルで一時公開。
- ログ：処理時間・リクエストID・モデルID・ルールIDのみ保存。音声・カナ文字列は保存しない。

## 10. テスト計画
- 検証素材：make it / can I / would you / want you / tell us / I’m in。
- 確認項目：
  - 単語消失が起きない（phones 配列に残る）。
  - 聴感に近いカタカナ（英会話教師が判定）。
  - オプション切替が出力に反映される。
  - 同一音声で同一JSON出力（確率ゆらぎなし）。

## 11. アンチ要件（禁止）
- 単語辞書による正解化。
- 綴り復元・句読点付与・スペル推定。
- Whisper や Vosk による代替。
- DB 保存・ユーザ認証。
